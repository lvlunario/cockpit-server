<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operator Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1e293b; --bg-light: #334155; --text-light: #e2e8f0;
            --text-dark: #94a3b8; --border-color: #475569; --meron-color: #10b981;
            --wala-color: #ef4444; --accent-color: #3b82f6; --standby-color: #f59e0b;
        }
        body {
            font-family: 'Roboto', sans-serif; background-color: var(--bg-dark);
            color: var(--text-light); margin: 0; padding: 1rem;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); }
        .tab-button {
            padding: 1rem 1.5rem; background: none; border: none; color: var(--text-dark);
            font-size: 1rem; cursor: pointer; border-bottom: 2px solid transparent;
        }
        .tab-button.active { color: var(--text-light); border-bottom-color: var(--accent-color); }
        .tab-content { display: none; padding: 2rem 0; }
        .tab-content.active { display: block; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .panel { background-color: var(--bg-light); border-radius: 8px; padding: 1.5rem; }
        .panel-title { font-size: 2rem; font-weight: 700; text-align: center; }
        .panel.meron .panel-title { color: var(--meron-color); }
        .panel.wala .panel-title { color: var(--wala-color); }
        .stat-group { margin-top: 1.5rem; }
        .stat { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0; border-bottom: 1px solid var(--border-color); }
        .stat .label { font-size: 1rem; color: var(--text-dark); }
        .stat .value { font-size: 1.5rem; font-weight: 500; }
        .controls { margin-top: 1.5rem; display: grid; gap: 0.8rem; }
        .controls .status-display {
            font-size: 1.2rem; text-align: center; font-weight: 700; padding: 1rem;
            border-radius: 6px; text-transform: uppercase;
        }
        .btn {
            width: 100%; padding: 0.8rem; font-size: 1rem; font-weight: 500;
            color: white; border: none; border-radius: 6px; cursor: pointer;
        }
        .btn-green { background-color: #16a34a; }
        .btn-red { background-color: #dc2626; }
        .btn-gray { background-color: #64748b; }
        .btn-blue { background-color: #2563eb; }
        .btn:disabled { background-color: #475569; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        {% csrf_token %}
        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'dashboard')">Dashboard</button>
            <button class="tab-button" onclick="openTab(event, 'wagers')">Entries</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <h2 id="event-name">Loading Active Event...</h2>
            <div class="dashboard-grid">
                <!-- MERON PANEL -->
                <div class="panel meron">
                    <div class="panel-title">MERON</div>
                    <div class="stat-group">
                        <div class="stat"><span class="label">Total Points</span><span class="value" id="meron-points">₱0.00</span></div>
                        <div class="stat"><span class="label">Payout Ratio</span><span class="value" id="meron-ratio">0.00</span></div>
                    </div>
                    <div class="controls">
                        <div class="status-display" id="meron-status">STANDBY</div>
                        <button class="btn btn-blue" id="open-entries-btn">Open Entries</button>
                        <button class="btn btn-red" id="close-entries-btn">Close Entries</button>
                        <button class="btn btn-green" id="meron-winner-btn">Declare Meron Winner</button>
                    </div>
                </div>
                <!-- WALA PANEL -->
                <div class="panel wala">
                    <div class="panel-title">WALA</div>
                    <div class="stat-group">
                        <div class="stat"><span class="label">Total Points</span><span class="value" id="wala-points">₱0.00</span></div>
                        <div class="stat"><span class="label">Payout Ratio</span><span class="value" id="wala-ratio">0.00</span></div>
                    </div>
                     <div class="controls">
                        <div class="status-display" id="wala-status">STANDBY</div>
                        <button class="btn btn-red" id="wala-winner-btn">Declare Wala Winner</button>
                        <button class="btn btn-gray" id="draw-winner-btn">Declare Draw</button>
                        <div style="text-align:center; color: var(--text-dark); margin-top: 1rem;">Timer controls coming soon</div>
                        <button class="btn btn-gray" disabled>Add 30 sec</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="wagers" class="tab-content">
            <h2>Entries & Financials</h2>
            <p>This section will show detailed entry lists and financial reports.</p>
        </div>
    </div>

<script>
    const API_BASE_URL = 'http://127.0.0.1:8000';
    let eventId = null;
    let statsInterval = null;

    const elements = {
        eventName: document.getElementById('event-name'),
        meronPoints: document.getElementById('meron-points'),
        walaPoints: document.getElementById('wala-points'),
        meronRatio: document.getElementById('meron-ratio'),
        walaRatio: document.getElementById('wala-ratio'),
        meronStatus: document.getElementById('meron-status'),
        walaStatus: document.getElementById('wala-status'),
        openEntriesBtn: document.getElementById('open-entries-btn'),
        closeEntriesBtn: document.getElementById('close-entries-btn'),
        meronWinnerBtn: document.getElementById('meron-winner-btn'),
        walaWinnerBtn: document.getElementById('wala-winner-btn'),
        drawWinnerBtn: document.getElementById('draw-winner-btn'),
    };

    function formatCurrency(value) {
        return '₱' + parseFloat(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function updateStatusDisplay(status) {
        [elements.meronStatus, elements.walaStatus].forEach(el => {
            el.textContent = status;
            if (status === 'OPEN') el.style.backgroundColor = 'var(--meron-color)';
            else if (status === 'CLOSED') el.style.backgroundColor = 'var(--wala-color)';
            else el.style.backgroundColor = 'var(--standby-color)';
        });
        
        const isEventOpen = status === 'OPEN';
        const isEventClosed = status === 'CLOSED';
        
        elements.openEntriesBtn.disabled = isEventOpen;
        elements.closeEntriesBtn.disabled = !isEventOpen;
        elements.meronWinnerBtn.disabled = !isEventClosed;
        elements.walaWinnerBtn.disabled = !isEventClosed;
        elements.drawWinnerBtn.disabled = !isEventClosed;
    }

    async function changeEntryStatus(status) {
        if (!eventId) return;
        try {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            await fetch(`${API_BASE_URL}/api/events/${eventId}/status/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ status: status })
            });
            fetchLiveStats();
        } catch (error) {
            console.error(`Error setting status to ${status}:`, error);
        }
    }
    
    async function declareWinner(winner) {
         if (!eventId) return;
         try {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            await fetch(`${API_BASE_URL}/api/events/${eventId}/end/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ winner: winner })
            });
            initialize();
         } catch(error) {
             console.error('Error declaring winner:', error);
         }
    }

    async function fetchLiveStats() {
        if (!eventId) return;
        try {
            const response = await fetch(`${API_BASE_URL}/api/events/${eventId}/stats/`);
            const data = await response.json();
            elements.meronPoints.textContent = formatCurrency(data.meron_total_points);
            elements.walaPoints.textContent = formatCurrency(data.wala_total_points);
            elements.meronRatio.textContent = data.meron_payout_ratio;
            elements.walaRatio.textContent = data.wala_payout_ratio;
            updateStatusDisplay(data.entry_status);
        } catch (error) { console.error('Error fetching live stats:', error); }
    }

    async function initialize() {
        if (statsInterval) clearInterval(statsInterval);
        try {
            const response

